<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Gastos</title>
    <!-- CSS -->
    <link rel="stylesheet" href="../../ventanas.css">
    <link rel="stylesheet" href="gastos.css">
    <link rel="stylesheet" href="../../header.css">
    <!-- INCLUIR JQUERY -->
    <script src="../../jquery/jquery-3.5.1.min.js"></script>
    <!-- ICONO -->
    <link rel="shortcut icon" type='image/x-icon' href='../../img/gasto.png'>
</head>
<body>
   
   <!-- CABECERA-->
  <header class='header'>
    <!-- TITULO -->
    <div class="header_title">
        <h1 class='header_tit'>Gastos</h1>
    </div>
    <!-- BOTON SALIR -->
    <div class="header_salir">
        <a href="#/" class='header_cta' onclick='cerrarSesion()'></a>
    </div>
  </header>
  
  
  <!--FECHA -->
  <div class="fecha">
      <h2 id='fecha'></h2>
  </div>
  
   
   <!-- MENU NAVEGACION -->
   <nav class="menunav">
       <a href="../inicio.html" class='menu_item menu_item-home'>Inicio</a><a href="gastos.html" class='menu_item'>/Gastos</a>
   </nav>

   <!-- SELECCIONAR GASTOS -->
   <div class="seleccionarGastos">
        <ul>
            <li><label for="radlocal" class='radio rd'>
                <input type='radio'  class='radMos radio_input' name='mosRad' id="radlocal" onclick='mostrarBuscar()' value="1" checked>
                <div class='radio_radio'></div>Por fecha
                </label></li>

            <li><label for="radlocal1" class='radio rd'>
                <input type='radio'  class='radMos radio_input' name='mosRad' id="radlocal1" onclick='mostrarBuscar()' value="2">
                <div class='radio_radio'></div>Por mes
                </label></li>   
        </ul>
   </div>
   

    
    <!-- FORMULARIO BUSCAR POR MES-->
   <div class="form_buscar" id="formBuscarMes">
       <select name="" id="fieldMes">
           <option value="01">Enero</option>
           <option value="02">Febrero</option>
           <option value="03">Marzo</option>
           <option value="04">Abril</option>
           <option value="05">Mayo</option>
           <option value="06">Junio</option>
           <option value="07">Julio</option>
           <option value="08">Agosto</option>
           <option value="09">Septiembre</option>
           <option value="10">Octubre</option>
           <option value="11">Noviembre</option>
           <option value="12">Diciembre</option>
       </select>
       
       <select name="" id="fieldAnual" class='anua'>
           <option value="2022">2022</option>
           <option value="2023">2023</option>
           <option value="2024">2024</option>
           <option value="2025">2025</option>
       </select>
       
       <button  class='form_cta' onclick='buscarGastos()'>Buscar</button>
   </div>
   <!-- MOSTRAR BUSCAR POR FECHA -->
   <div class="form_buscar" id="formBuscarFecha">
        <input type="date" id="fieldFecha">
    
    <button  class='form_cta' onclick='buscarGastos()'>Buscar</button>
</div>
   


   <!-- INDICADORES-->
   <div class='indicadores'>
       <ul>
           <li>Gastos totales: <span id="gastosTot"> </span></li>
           <li>Dinero en gastos: <span id="gastosDin"> </span></li>
           <li><a href="#/" onclick="agregarForm()">Agregar gastos</a></li>
       </ul>
   </div>
    
    
   <!-- CONTENIDO -->
   <section class='contenido_gastos'>

    <div class="mostrarGastos">


    </div>
     
       <!-- FORMULARIO GASTOS-->
       <div class='contenido_gastosForm'>
           <h2>Agregar gasto</h2>
           
           
           <!-- FORMULARIO GASTO -->
           <table class='container_tabla_form' id="formGastoNormal">
              <form id='form'>
               <tr>
                   <td><label>Concepto</label></td><td><input type="text" id='fieldConcepto' class='input_camp' pattern="[A-Za-z0-9_()/-]{1,50}" required></td>
               </tr>
               <tr>
                   <td><label>Proveedor</label></td><td><input type="text" id='fieldProveedor' class='input_camp' pattern="[A-Za-z0-9_()/-]{1,50}" required></td>
               </tr>
               <tr>
                   <td><label>Frecuencia</label></td><td>
                   <select id="fieldFrecuencia" class='input_camp'>
                      <option value="No especificar">No especificar</option>
                       <option value="Diario">Diario</option>
                       <option value="Semanal">Semanal</option>
                       <option value="Quincenal">Quincenal</option>
                       <option value="Mensual">Mensual</option>
                   </select></td>    
               </tr>
               <tr>
                   <td><label>Pago</label></td><td><input type="number" id='fieldPago' class='input_camp' pattern="[A-Za-z0-9_()/-]{1,50}" required></td>
               </tr>
               <tr>
                   <td><label>Fecha</label></td><td><input type="date" id='fieldFechacamp'  class='input_camp' required></td>
               </tr>
               <tr>
                   <td colspan='2' class='tabla_bottones'>
                       <input type="submit" value='Cancelar' class='tabla_cta' onclick='cancelarForm()'>
                   <input type="submit" value='Guardar' class='tabla_cta' onclick='agregarGasto()'></td>
               </tr>
               </form>
           </table>
           
       </div>
       
   </section>   
   <div id="resultado">

   </div> 
    
    
    <!-- /////////////////////////// -->
        <!-- VENTANA MODAL GENERAL -->
        <div class="modal_confirmado" id='modal'>
            <p class='modal_text'></p>
        </div>

           <!-- VENTANAS MODALES -->
   <script src="../../jquery/ventanas.js"></script>
   <script src="../fecha.js"></script>
</body>
</html>

<script type='text/javascript'>
    //EJECUTAR AL CARGAR EL DOCUMENTO
    $(document).ready(function(){
      
        
     fecha();//FECHA (FECHA.JS)
      
    //  campoBuscar();  
    //   //formatDate();//FECHA (FECHA.JS)  
        
    //   /////ARCHIVO USUARIO.JS
         validarUsuario();

        mostrarBuscar();
        buscarGastos();

    
    }); 
    

    let contenedor= document.querySelector(".mostrarGastos");
    let usuario=sessionStorage.getItem("usserA");

    //MOSTRAR FECHA EN CAMPO
    let date = new Date();
    let output = date.getFullYear() +"-"+ String(date.getMonth() + 1).padStart(2, '0')  + '-' + String(date.getDate()).padStart(2, '0');
        

    ///////////////////////////////////////////////////////////////////////
    //MOSTRAR FORMULARIO BUSCAR
    function mostrarBuscar(){
        let period=document.querySelector('input[name=mosRad]:checked').value;
        if(period==2){
            $("#formBuscarMes").show();
            $("#formBuscarFecha").hide();
            document.querySelector("#fieldMes").value=String(date.getMonth() + 1).padStart(2, '0');
            document.querySelector("#fieldAnual").value=date.getFullYear();
        }else{
            $("#formBuscarFecha").show();
            $("#formBuscarMes").hide();
            document.querySelector("#fieldFecha").value=output;
        }
    }

    ////////////////////////////////////////////////////////////////////////
    //MOSTRAR GASTOS
    function buscarGastos(){
        let period=document.querySelector('input[name=mosRad]:checked').value;
        let fieldMes=document.querySelector("#fieldMes").value || 0;
        let fieldAnual=document.querySelector("#fieldAnual").value || 0;
        let fieldFecha=document.querySelector("#fieldFecha").value || 0;

        console.log(usuario);
        $.ajax({
            type:'POST',
            url:'cargar_gastos.php',
            beforeSend: function() { Spinner(contenedor)},
            complete: function() { mostrarGastos()},
            data:{fieldMes,fieldAnual,fieldFecha,period,usuario},
            success:function(resps){
                // $("#resultado").html(resps);
            gastos=eval(resps);
            
            }
        });
    }
    
    function mostrarGastos(){
        limpiarHtml(contenedor);
        let sum=0;
        console.log(gastos);
        
        if(gastos.length>0){
            let table=document.createElement("table");
            let tr1=document.createElement("tr");
            tr1.innerHTML=`
                            <th>Concepto</th>
                            <th>Proveedor</th>
                            <th>Frecuencia</th>
                            <th>Costo</th>
                            <th>Fecha</th>
                            <th> </th>`;
            table.appendChild(tr1);
            contenedor.appendChild(table);

            for(let i=0; i<gastos.length; i++){

                let {idgasto,concepto, proveedor, frecuencia,costo,fecha,user, fechaformat} =gastos[i];
             

                        // const dia = new Date(fecha).getDate();
                        // const mes = new Date(fecha).getMonth();
                        // const ano = new Date(fecha).getFullYear();
                         let formatFecha=fechaformat;

                sum+=parseInt(costo);
               
                let tr2=document.createElement('tr');
                tr2.classList.add(`ed${idgasto}`);
                tr2.innerHTML=`
                        <td>${concepto}</td>
                        <td>${proveedor}</td>
                        <td>${frecuencia}</td>
                        <td>$${costo}</td>
                        <td>${formatFecha}</td>
                        <td>
                            <a href='#/' class='editar' id='editar${idgasto}' onclick='editarForm(${idgasto},\"${concepto}\",\"${proveedor}\",\"${frecuencia}\",\"${costo}\",\"${fecha}\")'></a>
                            <a href='#/' class='guardar' id='guardar${idgasto}' onclick='guardarGasto(${idgasto})'></a>
                            <a href='#/' class='eliminar' id='eliminar${idgasto}' onclick='eliminarGasto(${idgasto})'></a>  
                        </td>
                        <td class='tdUsuario'>${user}</td>`;
               
                table.appendChild(tr2);
            }
            contenedor.appendChild(table);

            //MOSTRAR DATOS EN INDICADORES
            document.querySelector('#gastosTot').textContent=new Intl.NumberFormat().format(gastos.length);
            document.querySelector('#gastosDin').textContent="$"+ new Intl.NumberFormat().format(sum);

        }else{
            let p=document.createElement('p');
            p.textContent='No hay gastos registrados en la fecha seleccionada';
            p.classList.add("nohay");
            contenedor.appendChild(p);
            document.querySelector(".contenido_gastos").style.boxShadow= "0 0 0 0";
            document.querySelector('#gastosTot').textContent=0
            document.querySelector('#gastosDin').textContent="$0";
        }
        validarUsuario();
    }

    function Spinner(content){
        const divSpinner = document.createElement('div');
            divSpinner.classList.add('spinner');
            divSpinner.innerHTML=`
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>`;
            content.appendChild(divSpinner);
    }

    function limpiarHtml(content){
        while(content.firstChild){
            content.removeChild(content.firstChild);
        }
    }


    ///////////////////////////////////////////////////////
    //AGREGAR GASTO
    function agregarForm(){
        $(".contenido_gastosForm").show();

        $(".mostrarGastos").hide();
        $(".seleccionarGastos").hide();
        $('.indicadores').hide();
        $(".form_buscar").hide();
        document.querySelector('#form').reset();
        document.querySelector('#fieldFechacamp').value=output;
        document.querySelector('.contenido_gastos').style.boxShadow="0 0 32px -16px rgba(0,0,0,0)";
    }

    function cancelarForm(){
        $(".contenido_gastosForm").hide();

        $(".mostrarGastos").show();
        $(".seleccionarGastos").show();
        $('.indicadores').show();
        mostrarBuscar();

        document.querySelector('#form').reset();
    }
    
    function agregarGasto(){
        //EVITAR ENVIAR FORMULARIO
        $("#form").on('submit', function(evt){
            evt.preventDefault();  
        });
        let fieldConcepto=document.querySelector('#fieldConcepto').value;
        let fieldProveedor=document.querySelector('#fieldProveedor').value;
        let fieldFrencuencia=document.querySelector('#fieldFrecuencia').value;
        let fieldPago=document.querySelector('#fieldPago').value;
        let fieldFecha=document.querySelector('#fieldFechacamp').value;


        if(fieldConcepto!="" && fieldProveedor!="" && fieldFrencuencia!="" && fieldPago!="" && fieldFecha!=""){
                $.ajax({
                type:'POST',
                url:'agregar_gastos.php',
                data:{fieldConcepto,fieldProveedor,fieldFrencuencia,fieldPago,fieldFecha,usuario},
                success:function(resps){
                let resultado=eval(resps);
                    if(resultado>0){
                        ventanasModales("bien","Gasto registrado");
                        cancelarForm();
                        buscarGastos();
                    }else{
                        ventanasModales("erro","Gasto no registrado");
                    }
                }
            });
        }else{
            ventanasModales("adve","Campos vacios");
        }
        


    }


    ////////////////////////////////////////////////////////
    //EDITAR

    function editarForm(idgasto,concepto,proveedor, frecuencia,costo,fecha){
        $("#guardar"+idgasto).show();
        $("#editar"+idgasto).hide();
        $("#eliminar"+idgasto).hide();
        let fila=document.querySelector(".ed"+idgasto);
          
            let col1=fila.getElementsByTagName("td")[0];
            let col2=fila.getElementsByTagName("td")[1];
            let col3=fila.getElementsByTagName("td")[2];
            let col4=fila.getElementsByTagName("td")[3];
            let col5=fila.getElementsByTagName("td")[4];

            //CAMPO CONCEPTO
            col1inp=col1.innerHTML=`<input type='text' class='input_camp input_edit' value='${concepto}'>`;
           
            //CAMPO CONCEPTO
            col2inp=col2.innerHTML=`<input type='text' class='input_camp input_edit' value='${proveedor}'>`;
            
            //CAMPO DE CATEGOR√çA
            let tiposFrecuencia=['Diario','Semanal','Quincenal','Mensual'];

            col3inp=col3.innerHTML=" ";
            let input3=document.createElement("select");
            input3.setAttribute("class", "input_camp input_edit fech");
            // let inpu3=input3.value=frecuencia;
            col3.appendChild(input3);
            
            let option = document.createElement("option");
                option.text=frecuencia;
                option.value=frecuencia;
            input3.appendChild(option);
           
            for(x=0; x<tiposFrecuencia.length; x++){
                    if(tiposFrecuencia[x]==frecuencia){
                    
                    }else{
                        let optionn = document.createElement("option");
                        optionn.value=tiposFrecuencia[x];
                        optionn.text=tiposFrecuencia[x];
                        input3.appendChild(optionn); 
                    }
                }

            //CAMPO COSTO
            col4inp=col4.innerHTML=`<input type='number' class='input_camp input_edit numb' value='${costo}'>`;
          
            //CAMPO FECHA
            col5inp=col5.innerHTML=`<input type='date' class='input_camp input_edit fech' value='${fecha}'>`;
           

    }


    function guardarGasto(idgasto){
        let fila=document.querySelector(".ed"+idgasto);
          
          let col1=fila.getElementsByTagName("input")[0].value;
          let col2=fila.getElementsByTagName("input")[1].value;
          let col3=fila.getElementsByTagName("select")[0].value;
          let col4=fila.getElementsByTagName("input")[2].value;
          let col5=fila.getElementsByTagName("input")[3].value;

          if(col1!="" && col2!="" && col3!="" && col4!="" && col5!=""){
                $.ajax({
                type:'POST',
                url:'editar_gastos.php',
                data:{col1,col2,col3,col4,col5,idgasto},
                success:function(resps){
                let resultado=eval(resps);
              
                    if(resultado>0){
                        ventanasModales("bien","Gasto actualizado");
                        buscarGastos();
                    }else{
                        ventanasModales("erro","Gasto no actualizado");
                    }
                }
            });
        }else{
            ventanasModales("adve","Campos vacios");
        }
          
    }

    //////////////////////////////////////////////////////////
    //ELIMINAR GASTO
    function eliminarGasto(idgasto){
        $.ajax({
            type:'POST',
            url:'eliminar_gastos.php',
            data:{idgasto},
            success:function(resps){
            let resultado=eval(resps);
                if(resultado==0){
                    ventanasModales("bien","Gasto eliminado");
                    buscarGastos();
                }else{
                    ventanasModales("erro","Gasto no eliminado");
                }
            }
        });
    }


    //////////////////////////////////////////////////////
    //USUARIO
    function validarUsuario(){
        usuario==null ? cerrarSesion() : '';
    }
    function cerrarSesion(){
        sessionStorage.removeItem("usserA");
        window.location.href='../index.html';
    }
    
    
</script>