<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' >
    <!--<meta name="viewport" content="width=device-width,initial-scale=1.0">
    -->
    <title>Historial</title>
    <!-- CSS -->
    <link rel="stylesheet" href="historial.css">
    <link rel="stylesheet" href="../../header.css">
    <link rel="stylesheet" href="../../spinner.css">
    <link rel="stylesheet" href="../../ventanas.css">
    
    <!-- ICONO -->
    <link rel="shortcut icon" type='image/x-icon' href='../../img/ordenar.png'> 
</head>
<body>
   
   <!-- CABECERA-->
  <header class='header'>
   
    <!-- TITULO -->
    <div class="header_title">
        <h1 class='header_tit'>Historial</h1>
    </div>
    
    <!-- BOTON SALIR -->
   
    <div class="header_salir">
        <a href="../index.html" class='header_cta' onclick='cerrarSesion()'></a>
    </div>
  </header>
  <div id="versionSistema">
    <p>Versión 2.0</p>
  </div>
  
  <!-- CONTAR CLIENTES -->
    <div class='contar_clientes'>
        <h1>Clientes atendidos: <spam id='ordent'> </spam></h1>
        <p id='total'></p>
    </div>

       <!-- BUSCAR CUENTAS POR FECHA -->
    <div class="form_buscar">
        <p>Buscar cuentas por fecha</p>
        <input type="date" id="fieldFecha" onchange="cargarCuentas()">
        <!-- <button onclick="cargarCuentas()">Buscar</button> -->
    </div>


    <!-- BUSCAR VENTAS -->
<section class='contenido_buscar'> 
    <!-- FORM DE BUSCAR -->
     <div class='form_buscar'>
         <input type="text" class='form_input' id='fieldBuscar' placeholder="Domicilio, cliente o mesa">
         <button onclick='filtroBuscar()' class='form_cta'>Buscar</button>
        
     </div>
  
    
  <!-- MOSTRAR ORDENES ENTREGADAS-->
  <section class='mostrar_historial'>



      
  </section>




        <!-- VENTANA MODAL DINERO EN CAJA -->
        <div class="divFondo">
            <div class="divContenedor">
                <table>
                    <tr>
                        <th><h1>Dinero en caja</h1></th>
                    </tr>
                    <tr>
                        <td><input type="number" value=0 id="dineroCaja"> </td>
                    </tr>
                    <tr>
                        <td class="divError">¡Por favor ingresa un numero valido!</td>
                    </tr>
                    <tr>
                        <td><button class="cta" onclick="dineroCajaGuardar()">Aceptar</button></td>
                    </tr>
                </table>
            </div>
        </div>

          <!-- /////////////////////////// -->
    <!-- VENTANA MODAL GENERAL -->
    <div class="modal_confirmado" id='modal'>
        <p class='modal_text'></p>
    </div>

    <div id="resultado">

    </div>


  <!-- PIE DE PAGINA HISTORIAL -->
  <footer>
    <p><a href="../caja.html">Regresar</a></p>
    <h5>Caja: <a href="#/" onclick="dineroCajaMostrarForm()" id="dineroCantidad"><a></h5>
  </footer>
  
  <!-- INCLUIR JQUERY -->
  <script src="../../jquery/jquery-3.5.1.min.js"></script>
  <script src='../../jquery/ventanas.js'></script>
  <!-- <script src='../../jquery/usuario.js'></script> -->
</body>
</html>

<script type="text/javascript">    
    //EJECUTAR AL CARGAR EL DOCUMENTO
$(document).ready(function(){
        //    contador();
        //    buscar(); 
        //    /////ARCHIVO USUARIO.JS
        //    validarUsuario("caj");

        cargarCuentas();

           //MOSTRAR DINERO EN CAJA
           dineroCajaMostrar();
});

//VARIABLES
const fecha = new Date();     
let fechaFor=fecha.toLocaleDateString();
let ventas=[];
let contenedor=document.querySelector('.mostrar_historial');
let usuario=sessionStorage.getItem("usserCaj");
//MOSTRAR FECHA EN CAMPO
let output = fecha.getFullYear() +"-"+ String(fecha.getMonth() + 1).padStart(2, '0')  + '-' + String(fecha.getDate()).padStart(2, '0');
    document.querySelector("#fieldFecha").value=output;


//AGREGAR FUNCION AL PRESIONAR TECLA EN BUSCAR
document.querySelector("#fieldBuscar").addEventListener("input", filtroBuscar);



////////////////////////////////////////////
    //DINERO EN CAJA MOSTRAR DINERO EN FOOTER
    function dineroCajaMostrar(){
        const dineroLocal=JSON.parse(localStorage.getItem("DineroCaja"));
        document.querySelector('#dineroCantidad').textContent="$"+dineroLocal.dinero;

    }
    //DINERO EN CAJA, MOSTRAR CANTIDAD
    function dineroCajaMostrarForm(){
        const div=document.querySelector(".divFondo");
        div.style.display='flex';

        const dineroLocal=JSON.parse(localStorage.getItem("DineroCaja"));
        document.querySelector('#dineroCaja').value=dineroLocal.dinero;

        }

    //DINERO EN CAJA, ACTUALIZAR
    function dineroCajaGuardar(){
        //VARIABLES
        const dineroCaja = parseInt(document.querySelector('#dineroCaja').value);
        
        

        //VALIDAR QUE SI SE ESCRIBIO UNA CANTIDAD
        if(dineroCaja!=""){
            let objDinero={
                dinero : dineroCaja,
                fecha: fechaFor
            }

            localStorage.setItem("DineroCaja", JSON.stringify(objDinero));//GUARDAR LOCALSTORAGE
        }else{
            $(".divError").slideToggle('fast');
                        setTimeout(function (){
                                $(".divError").slideToggle('fast');
                                },2000
                            );
        }
        dineroCajaMostrar();
        $(".divFondo").hide();
        
    }




/////////////////////////////////////////////
//CARGAR CUENTAS PAGADAS
function cargarCuentas(){
    let fieldFecha=document.querySelector('#fieldFecha').value;
               $.ajax({
				type:'POST',
                beforeSend: function() { Spinner()},
                complete: function() {filtroBuscar(),validarUsuario() },
                data:{fieldFecha},
				url:'cargar_cuentas.php',
				success:function(resp){
                   ventas = eval(resp);  
                },
           });
     }


function filtroBuscar(){
    let fieldBuscar= document.querySelector("#fieldBuscar").value;
        ventasbuscar=[];
        ventas.forEach(p=>{
                    let resultado= p.lugar.includes(fieldBuscar); 
                    if(resultado){
                        ventasbuscar.push(p);
                    }
        });
        mostrarVentas(ventasbuscar);
}

function mostrarVentas(ventasbuscar){
    limpiarHtml(contenedor);

    document.querySelector('#ordent').textContent=ventasbuscar.length;
    let totalVentas=0;
     //VALIDAR SI HAY VENTAS
     if(ventasbuscar.length>0){

        totalVentas=ventasbuscar.reduce((total, producto)=>total + parseInt(producto.totalVenta),0);

        for(v=0; v<ventasbuscar.length; v++){
            let {consumo, lugar, totalVenta, envio, hora, idhistocliente, ordenes} = ventasbuscar[v];

            let ventaCliente=JSON.stringify(ventasbuscar[v]);

            let div1=document.createElement('div');
                div1.classList.add("mesas");
                div1.innerHTML=`<nav>
                        <table>
                            <tr>
                                <th colspan='2' class='iconCliente'><p class='mesa'>${lugar}</p></th>
                                <th colspan='2' class='iconImprimir'><a href='#/' class='linkTicket' onclick='imprimirTicket(${ventaCliente})'>Imprimir ticket</a></th>
                                <th class='total'>Total <span>$${new Intl.NumberFormat().format(totalVenta)}</span></th>
                            </tr>
                            <tr>
                                
                            </tr>
                        </table>
                        <a href='#/' class='eliminarCliente' onclick='eliminarVenta(${ventaCliente})'></a>
                    </nav>`;

                    //ORDENES
                    let div2= document.createElement('div');
                        div2.classList.add("ordenes");

                    let table=document.createElement('table');
                    let tr1= document.createElement("tr");
                        tr1.innerHTML=`<th>Cantidad</th>
                                        <th>Categoria</th>
                                        <th>Producto</th>
                                        <th>Costo</th>
                                        <th>Total</th>
                                        <th>Duración</th>`;
                        table.appendChild(tr1);
                    for(o=0; o<ordenes.length; o++){
                        let {cantidad, categoria, producto, costo, total, tiempoEntrega}= ordenes[o];
                        let tr2= document.createElement('tr');
                            tr2.innerHTML=`<td>${cantidad}</td>
                                            <td>${categoria}</td>
                                            <td>${producto}</td>
                                            <td>$${costo}</td>
                                            <td>$${total}</td>
                                            <td>${tiempoEntrega}</td>`;
                        table.appendChild(tr2);

                    }

                    //MOSTRAR COSTO DE ENVIO
                    if(consumo==3){
                        let tr3=document.createElement('tr');
                        tr3.innerHTML=`<td colspan='5' class='mostEnv'>Envio: <span>$${envio}</span></td>`;
                        table.appendChild(tr3);
                    }
                    

                    //HORA DE LA VENTA
                    let div3=document.createElement('div');
                        div3.classList.add("horaVenta");
                        div3.innerHTML=`<p>${hora}</p>`;


                    div2.appendChild(table);
                    div1.appendChild(div2);
            
            contenedor.appendChild(div1);
            contenedor.appendChild(div3);
            
        }


        
     }else{
        //NO HAY VENTAS
        let p= document.createElement("p");
            p.textContent="No hay ventas registradas";
            p.classList.add("nohay");
            contenedor.appendChild(p);
     }

     document.querySelector('#total').textContent="$"+new Intl.NumberFormat().format(totalVentas);

}



function Spinner(){
    const divSpinner = document.createElement('div');
    divSpinner.classList.add('spinner');
    divSpinner.innerHTML=`
    <div class="bounce1"></div>
    <div class="bounce2"></div>
    <div class="bounce3"></div>`;
    contenedor.appendChild(divSpinner);
}

function limpiarHtml(content){
    while(content.firstChild){
        content.removeChild(content.firstChild);
    }
}


/////////////////////////////////////////////////////////////////////////
//IMPRIMIR TICKET

function imprimirTicket(ventaCliente){

    //VARIABLES
    let ordenesAgrupadas=[];

//ORDENES DE LA CUENTA DEL CLIENTE
let ordenes =ventaCliente.ordenes;

for(o=0; o<ordenes.length; o++){
    let {producto, categoria, costo,cantidad,total}=ordenes[o];
    const resultado = ordenesAgrupadas.filter(pro => pro.producto == producto && pro.costo==costo && pro.categoria==categoria);
    
     if(resultado.length>0){
        resultado[0].cantidad=parseInt(resultado[0].cantidad)+parseInt(cantidad);
        resultado[0].total=parseInt(resultado[0].cantidad)*parseInt(costo);
     }else{
        orden={
            "producto": producto,
            "categoria":categoria,
            "cantidad": parseInt(cantidad),
            "costo": parseInt(costo),
            "total": parseInt(total)
        }
        ordenesAgrupadas.push(orden);
     }
}


//ORDENES AGRUPADAS AGREGADAS AL CLIENTE
ventaCliente.ordenes=ordenesAgrupadas;

let venta=JSON.stringify(ventaCliente);


  window.open("ticketHistorial.php?ven="+venta,'_blank');
}


/////////////////////////////////////////////////////////////////////////
//ELIMINAR VENTA

function eliminarVenta(ventaCliente){

    $.ajax({
            type:'POST',
            url:'eliminar_venta.php',
            data:{venta:JSON.stringify(ventaCliente),usuario},
            success:function(respro){
                // $("#resultado").html(respro);
                 let resultado = eval(respro);
                 if(resultado==0){
                     ventanasModales("bien","Cuenta eliminada");
                     cargarCuentas();
                    
                 }else{
                     ventanasModales("erro","Cuenta no eliminada");
                 }
            
            }
         }); 

}



////////////////////////////////////////////////////////////////////////
    //USUARIO
    function validarUsuario(){
        if(usuario==null){
            cerrarSesion();
        }else{
            document.querySelector('.header_cta').textContent=usuario;
        }
    }

    function cerrarSesion(){
        sessionStorage.removeItem("usserCaj");
        localStorage.removeItem('cuentasVaradero');
         localStorage.removeItem("costoEnvioVaradero");
        window.location.href='index.html';
    }









    // const fecha = new Date();
    // let fechaFor=fecha.toLocaleDateString();
////////////////////////////////////////////////////

// function contador(){
        
//         $.ajax({
//         type:'POST',
//         url:'contar_clientes.php',
//         success:function(resp){
//             let resultado=eval(resp);
//             document.querySelector("#ordent").innerHTML=resultado[0];
//             document.querySelector("#total").innerHTML=`$${resultado[1]}`;
//             }
//         });
        
//     }

//     function buscar(){
//         let bus=document.querySelector('#busc_venta').value;
//         $.ajax({
//         type:'POST',
//         url:'mostrar_historial.php',
//         data:{cli:bus},
//         success:function(resp){
//             $(".mostrar_historial").html(resp);
            
//             }
//         });
//     }


//     function eliminarCliente(id){
//         $.ajax({
//             type:'POST',
//             url:'eliminar_cliente.php',
//             data: {id:id},
//             success:function(resp){
//                 let resultado=eval(resp);
               
//                 if(resultado==0){
//                     //CLIENTE ELIMINADO

//                     //MOSTRAR VENTANA CLIENTE ELIMINADO
//                     $("#eliminadoCliente").slideToggle('fast');
//                             setTimeout(function (){
//                                     $("#eliminadoCliente").slideToggle('fast');
//                                     },2000
//                                 );
//                 }else{
//                     //CLIENTE NO ELIMINADO

//                     //MOSTRAR VENTANA CLIENTE NO ELIMINADO
//                     $("#noeliminadoCliente").slideToggle('fast');
//                             setTimeout(function (){
//                                     $("#noeliminadoCliente").slideToggle('fast');
//                                     },2000
//                                 );
//                 }
//                     contador();
//                     buscar(); 
//                 }
//             });
//     }


    
    // function imprimirTicket(idcliente,envio,total){
    //     window.open("ticketHistorial.php?idcliente="+idcliente+"&env="+envio+"&tot="+total,'_blank');
    // }


</script>
